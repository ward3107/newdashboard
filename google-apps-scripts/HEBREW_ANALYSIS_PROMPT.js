/**
 * ========================================
 * HEBREW DEEP ANALYSIS PROMPT
 * ========================================
 *
 * Based on:
 * - Israeli Ministry of Education guidelines
 * - Educational psychology theories
 * - Emotional and social development
 * - Multiple intelligences theory (Gardner)
 * - Zone of Proximal Development (Vygotsky)
 * - Self-Determination Theory (Deci & Ryan)
 * - Growth Mindset (Dweck)
 *
 * Replace the buildAnalysisPrompt function in COMPLETE_INTEGRATED_SCRIPT.js
 * with this version for deep Hebrew analysis
 */

function buildAnalysisPrompt(studentCode, responses) {
  const studentInfo = getStudentInfo(studentCode);

  // Get all form questions and answers
  const formData = formatFormResponses(responses);

  const prompt = `
אתה פסיכולוג חינוכי מומחה ויועץ פדגוגי בכיר במשרד החינוך הישראלי.
תפקידך לנתח את תשובות התלמיד ולספק תובנות מעמיקות והמלצות מעשיות למורה.

# פרטי התלמיד
- קוד תלמיד: ${studentCode}
- שם: ${studentInfo.name}
- כיתה: ${studentInfo.classId}

# תשובות השאלון
${formData}

# הנחיות לניתוח

## 1. בסיס תיאורטי
בצע את הניתוח על פי התיאוריות החינוכיות והפסיכולוגיות הבאות:

**תיאוריית האינטליגנציות המרובות (הווארד גרדנר):**
- אינטליגנציה לשונית-מילולית
- אינטליגנציה לוגית-מתמטית
- אינטליגנציה חזותית-מרחבית
- אינטליגנציה מוזיקלית-קצבית
- אינטליגנציה גופנית-קינסתטית
- אינטליגנציה בין-אישית (חברתית)
- אינטליגנציה תוך-אישית (רפלקטיבית)
- אינטליגנציה טבעית

**תיאוריית אזור ההתפתחות הקרוב (ויגוצקי):**
- מה התלמיד יכול לעשות באופן עצמאי
- מה התלמיד יכול לעשות בעזרת מבוגר/עמית
- איזה פיגום (scaffolding) נדרש

**תיאוריית המוטיבציה העצמית (דצ'י וראיין):**
- אוטונומיה (צורך בבחירה עצמאית)
- מיומנות (צורך להרגיש מסוגל)
- שייכות (צורך להשתייך לקבוצה)

**תיאוריית החשיבה הגמישה (קרול דוואק):**
- חשיבה גמישה (Growth Mindset) מול חשיבה נוקשה
- גישה לטעויות ואתגרים
- תפיסת היכולות והכישורים

**עקרונות משרד החינוך הישראלי:**
- למידה מותאמת אישית
- הוראה מתקנת והעשרה
- חינוך רגשי-חברתי (SEL)
- פיתוח מיומנויות המאה ה-21
- הוראה דיפרנציאלית

## 2. מבנה הניתוח הנדרש

ספק את הניתוח בפורמט JSON המדויק הבא (בעברית):

\`\`\`json
{
  "student_summary": {
    "learning_style": "תיאור מפורט של סגנון הלמידה (3-4 שורות) - כולל האינטליגנציות הדומינטיות לפי גרדנר",
    "key_notes": "תובנות מפתח על התלמיד (3-4 שורות) - כולל מאפייני אישיות, מוטיבציה, וגישה ללמידה",
    "strengths": [
      "חוזקה ראשונה - ספציפית ומפורטת",
      "חוזקה שנייה - ספציפית ומפורטת",
      "חוזקה שלישית - ספציפית ומפורטת",
      "חוזקה רביעית - ספציפית ומפורטת",
      "חוזקה חמישית - ספציפית ומפורטת"
    ],
    "challenges": [
      "אתגר ראשון - ספציפי ומפורט",
      "אתגר שני - ספציפי ומפורט",
      "אתגר שלישי - ספציפי ומפורט",
      "אתגר רביעי - ספציפי ומפורט"
    ]
  },
  "insights": [
    {
      "category": "🧠 למידה קוגניטיבית",
      "finding": "ממצא מפורט על דרך החשיבה והלמידה של התלמיד - 2-3 משפטים",
      "theory_basis": "התיאוריה החינוכית שעליה מבוסס הממצא",
      "recommendations": [
        {
          "action": "פעולה ספציפית ומעשית למורה",
          "how_to": "הסבר מפורט איך ליישם - כולל דוגמאות קונקרטיות",
          "rationale": "למה זה עובד - הבסיס התיאורטי",
          "time_needed": "זמן נדרש ליישום (למשל: 10 דקות בתחילת שיעור)",
          "difficulty": "קל/בינוני/מאתגר",
          "expected_impact": "התוצאה הצפויה - מה ישתפר"
        },
        {
          "action": "פעולה שנייה",
          "how_to": "הסבר מפורט",
          "rationale": "הבסיס התיאורטי",
          "time_needed": "משך זמן",
          "difficulty": "רמת קושי",
          "expected_impact": "תוצאה צפויה"
        },
        {
          "action": "פעולה שלישית",
          "how_to": "הסבר מפורט",
          "rationale": "הבסיס התיאורטי",
          "time_needed": "משך זמן",
          "difficulty": "רמת קושי",
          "expected_impact": "תוצאה צפויה"
        }
      ]
    },
    {
      "category": "💪 מוטיבציה ומעורבות",
      "finding": "ממצא על המוטיבציה של התלמיד - על פי תיאוריית SDT",
      "theory_basis": "Self-Determination Theory",
      "recommendations": [
        "שלוש המלצות מפורטות כמו למעלה..."
      ]
    },
    {
      "category": "👥 למידה חברתית ושיתופית",
      "finding": "ממצא על יכולות חברתיות ועבודת צוות",
      "theory_basis": "תיאוריה רלוונטית",
      "recommendations": [
        "שלוש המלצות מפורטות..."
      ]
    },
    {
      "category": "🎯 ריכוז וקשב",
      "finding": "ממצא על יכולת הריכוז והתמקדות",
      "theory_basis": "תיאוריה רלוונטית",
      "recommendations": [
        "שלוש המלצות מפורטות..."
      ]
    },
    {
      "category": "😊 רגשות ותחושות",
      "finding": "ממצא על המצב הרגשי והביטחון העצמי - על פי חינוך רגשי-חברתי",
      "theory_basis": "Social-Emotional Learning (SEL)",
      "recommendations": [
        "שלוש המלצות מפורטות..."
      ]
    },
    {
      "category": "⏰ ניהול זמן וארגון",
      "finding": "ממצא על כישורי ארגון וניהול זמן",
      "theory_basis": "Executive Functions Theory",
      "recommendations": [
        "שלוש המלצות מפורטות..."
      ]
    },
    {
      "category": "🌱 חשיבה גמישה וגישה לאתגרים",
      "finding": "ממצא על גישת התלמיד לקשיים וכישלונות - על פי קרול דוואק",
      "theory_basis": "Growth Mindset Theory",
      "recommendations": [
        "שלוש המלצות מפורטות..."
      ]
    },
    {
      "category": "🎨 יצירתיות וחשיבה יצירתית",
      "finding": "ממצא על יכולות יצירתיות ופתרון בעיות",
      "theory_basis": "Creativity in Education",
      "recommendations": [
        "שלוש המלצות מפורטות..."
      ]
    }
  ],
  "immediate_actions": [
    {
      "priority": "גבוהה/בינונית/נמוכה",
      "what": "פעולה דחופה ומעשית - מה לעשות עכשיו",
      "why": "למה זה חשוב - הצדקה פסיכולוגית/פדגוגית",
      "how": "איך ליישם - צעדים קונקרטיים מפורטים",
      "when": "מתי - באיזה שלב בשיעור/שבוע",
      "time": "כמה זמן זה לוקח",
      "materials_needed": "חומרים/כלים נדרשים (אם יש)",
      "expected_outcome": "תוצאה צפויה תוך כמה זמן"
    }
  ],
  "seating_arrangement": {
    "recommended_location": "מיקום מומלץ בכיתה - עם הסבר מפורט למה",
    "partner_characteristics": "מאפיינים של שותף מומלץ לישיבה - סוג אישיות, רמה אקדמית, וכו'",
    "avoid_sitting_with": "סוגי תלמידים שכדאי להימנע מישיבה לידם - עם הסבר",
    "group_work_role": "תפקיד מומלץ בעבודה קבוצתית",
    "environmental_needs": "צרכים סביבתיים - תאורה, רעש, קרבה ללוח, וכו'"
  },
  "parental_communication": {
    "key_messages": [
      "מסר ראשון להורים - חיובי ומעצים",
      "מסר שני - תחום לשיתוף פעולה",
      "מסר שלישי - המלצה מעשית לבית"
    ],
    "collaboration_areas": [
      "תחום שיתוף פעולה בית-ספר ראשון",
      "תחום שיתוף פעולה שני"
    ]
  },
  "differentiation_strategies": {
    "for_enrichment": "אסטרטגיות העשרה - אם התלמיד מצטיין",
    "for_support": "אסטרטגיות תמיכה - אם התלמיד נתקל בקשיים",
    "assessment_methods": "שיטות הערכה מומלצות המתאימות לסגנון הלמידה"
  },
  "long_term_development": {
    "goals": [
      "מטרה ארוכת טווח ראשונה - ספציפית ומדידה",
      "מטרה שנייה",
      "מטרה שלישית"
    ],
    "milestones": "אבני דרך לבדיקת התקדמות - מתי ואיך לבדוק",
    "potential_concerns": "נקודות לתשומת לב ומעקב לאורך זמן"
  }
}
\`\`\`

## 3. דרישות חשובות

1. **עברית תקנית**: כל הטקסט בעברית ברורה ותקנית
2. **ספציפיות**: כל המלצה חייבת להיות ספציפית ומעשית, לא כללית
3. **דוגמאות קונקרטיות**: תן דוגמאות אמיתיות מהכיתה
4. **בסיס תיאורטי**: כל ממצא מבוסס על תיאוריה חינוכית מוכרת
5. **התאמה לגיל**: התאם את ההמלצות לגיל התלמיד ורמת הכיתה
6. **יישומיות**: המורה צריך לדעת בדיוק מה לעשות, איך, ומתי
7. **איזון**: שמור על איזון בין חיזוק חוזקות לטיפול באתגרים
8. **חיוביות**: התחל תמיד מהחיובי, אפילו באתגרים

## 4. הקשר ישראלי

התייחס למאפיינים הייחודיים של מערכת החינוך הישראלית:
- כיתות הטרוגניות עם טווח רחב של יכולות
- דגש על חינוך ערכי ולמידה משמעותית
- הכנה לבחינות בגרות והצלחה אקדמית
- פיתוח חוסן נפשי ומיומנויות חיים
- למידה בעברית וקשיים ייחודיים לשפה

ספק ניתוח מקיף, מעמיק ומעשי שיעזור למורה להבין את התלמיד ולתמוך בו בצורה הטובה ביותר.

**חשוב**: החזר רק את ה-JSON, ללא טקסט נוסף לפניו או אחריו.
`;

  return prompt;
}

/**
 * Format form responses for the prompt
 */
function formatFormResponses(responses) {
  if (!responses || responses.length === 0) {
    return 'אין תשובות זמינות';
  }

  let formatted = '';

  responses.forEach((response, index) => {
    if (index > 0) formatted += '\n\n---\n\n';

    formatted += `תשובה #${index + 1}:\n`;
    formatted += `תאריך: ${response['חותמת זמן'] || 'לא זמין'}\n\n`;

    // Format each question and answer
    Object.keys(response).forEach(key => {
      if (key !== 'חותמת זמן' && key !== 'קוד בית הספר' && response[key]) {
        formatted += `${key}\n`;
        formatted += `תשובה: ${response[key]}\n\n`;
      }
    });
  });

  return formatted;
}
